!function(e){e.SUBMODULES_VERSION="1.0.0",e.SUBMODULES_VERNUM=0,e.namespaces={};class t{}class n{}function i(n){n in e.namespaces||(e.namespaces[n]=new t)}e.require=function(t){return i(t),e.namespaces[t]},e.namespace=function(t,r){i(t);var s=new n;for(var o in r(s),s)e.namespaces[t][o]=s[o]}}(this),namespace("com.subnodal.nanoplay.webapi",(function(e){})),namespace("com.subnodal.nanoplay.webapi.ble",(function(e){const t="6e400001-b5a3-f393-e0a9-e50e24dcca9e";e.SystemSupportError=class extends Error{},e.ConnectionError=class extends Error{},e.QueuedData=class{constructor(e,t){this.data=e,this.promiseResolver=t,this.maxLength=this.data.length}},e.Connection=class{constructor(){if("https"!=window.location.protocol&&"localhost"!=window.location.hostname&&"127.0.0.1"!=window.location.hostname)throw new e.SystemSupportError("Web Bluetooth can only be used in HTTPS contexts (or if the page is served as localhost)");if(!e.Connection.systemSupported())throw new e.SystemSupportError("Your system does not support Web Bluetooth");this.bleServer=null,this.bleService=null,this.bleRxCharacteristic=null,this.bleTxCharacteristic=null,this.bleTxQueue=[],this.bleFlowXoff=null,this.isOpen=!1,this.isOpening=!1,this.isBusy=!1,this.txInProgress=!1,this.rxData=""}static systemSupported(){return!!navigator.bluetooth}connect(){var e=this;return new Promise((function(n,i){navigator.bluetooth.requestDevice({filters:[{namePrefix:"NanoPlay "},{services:[t]}],optionalServices:[t]}).then((function(t){return t.addEventListener("gattserverdisconnected",(function(){e.disconnect()})),t.gatt.connect()})).then((function(n){return e.bleServer=n,n.getPrimaryService(t)})).then((function(t){return e.bleService=t,t.getCharacteristic("6e400003-b5a3-f393-e0a9-e50e24dcca9e")})).then((function(t){return e.bleRxCharacteristic=t,t.addEventListener("characteristicvaluechanged",(function(t){for(var n=t.target.value,i=0;i<n.length;i++){var r=n.getUint8(i);17==r?e.bleFlowXoff=!1:19==r&&(e.bleFlowXoff=!0)}var s=function(e){return String.fromCharCode.apply(this,new Uint8Array(e))}(n.buffer);this.rxData+=s})),t.startNotifications()})).then((function(){return e.bleService.getCharacteristic("6e400002-b5a3-f393-e0a9-e50e24dcca9e")})).then((function(t){e.bleTxCharacteristic=t})).then((function(){e.bleTxQueue=[],e.isOpen=!0,e.isOpening=!1,e.isBusy=!1,e.txInProgress=!1,e.write(),n()})).catch((function(t){i(t),e.disconnect()}))}))}disconnect(){this.bleServer.disconnect(),this.bleServer=null,this.bleRxCharacteristic=null,this.bleTxCharacteristic=null,this.isOpen=!1,this.isOpening=!1}write(t,n=function(){}){var i=this;return this.isBusy=!0,new Promise((function(r,s){t&&i.bleTxQueue.push(new e.QueuedData(t,r)),i.isOpen&&!i.txInProgress&&function e(){if(i.bleFlowXoff)setTimeout(e,100);else if(0!=i.bleTxQueue.length){var t=null,r=i.bleTxQueue[0];n(r.maxLength-r.data.length,r.maxLength),r.data.length<=20?(t=r.data,r.data=""):(t=r.data.substring(0,20),r.data=r.data.substring(20)),i.txInProgress=!0,i.bleTxCharacteristic.writeValue(function(e){for(var t=new ArrayBuffer(e.length),n=new Uint8Array(t),i=0;i<e.length;i++)n[i]=e.charCodeAt(i);return t}(t)).then((function(){0==r.data.length&&(i.bleTxQueue.shift(),r.promiseResolver()),i.txInProgress=!1,e()})).catch((function(e){i.bleTxQueue=[],i.disconnect(),s(e),i.isBusy=!1}))}else i.isBusy=!1}()}))}communicate(t,n=function(){},i=!1,r=function(){}){var s=this;if(!this.isOpen)throw new e.ConnectionError("Please connect to your NanoPlay first");this.isBusy?setTimeout((function(){s.communicate(t,n,i)}),100):this.write(t,r).then((function(){var e=0;setTimeout((function t(){console.log(e,3e3),e<3e3?setTimeout(t,100):(console.log("Timed out"),i&&console.warn("Newline callback timed out"),n(s.rxData),rxData=""),e+=10}),100)}))}evaluate(t,n){if(!this.isOpen)throw new e.ConnectionError("Please connect to your NanoPlay first");this.communicate(`eval(process.env.CONSOLE).println(JSON.stringify(\`${t}\`));`,(function(e){try{n(JSON.parse(e.trim()))}catch(e){}}),!0)}}}));